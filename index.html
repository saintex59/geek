<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar AÃ©rien â€“ VendÃ©e</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root {
    --radar-green: #00ff88;
    --radar-cyan: #00d4ff;
    --radar-orange: #ff6b00;
    --bg-dark: #020c14;
    --bg-panel: rgba(0,20,35,0.92);
    --grid: rgba(0,255,136,0.07);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg-dark);
    color: var(--radar-green);
    font-family: 'Rajdhani', sans-serif;
    height: 100vh;
    overflow: hidden;
    position: relative;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--grid) 1px, transparent 1px),
      linear-gradient(90deg, var(--grid) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridScroll 20s linear infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes gridScroll {
    0% { background-position: 0 0; }
    100% { background-position: 40px 40px; }
  }

  /* Scan line overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.15) 2px,
      rgba(0,0,0,0.15) 4px
    );
    pointer-events: none;
    z-index: 1;
  }

  /* HEADER */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    background: linear-gradient(180deg, rgba(0,10,20,0.98) 0%, rgba(0,10,20,0.85) 100%);
    border-bottom: 1px solid rgba(0,255,136,0.3);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    backdrop-filter: blur(10px);
  }

  .radar-icon {
    width: 42px; height: 42px;
    border: 2px solid var(--radar-green);
    border-radius: 50%;
    position: relative;
    animation: radarSpin 3s linear infinite;
    flex-shrink: 0;
  }

  .radar-icon::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 2px;
    height: 50%;
    background: var(--radar-green);
    transform-origin: bottom center;
    transform: translateX(-50%);
    box-shadow: 0 0 8px var(--radar-green);
  }

  .radar-icon::after {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 100%; height: 100%;
    transform: translate(-50%, -50%);
    background: conic-gradient(from 0deg, transparent 70%, rgba(0,255,136,0.4) 100%);
    border-radius: 50%;
    animation: radarSpin 3s linear infinite;
  }

  @keyframes radarSpin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  h1 {
    font-family: 'Orbitron', monospace;
    font-size: 1.4rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    text-shadow: 0 0 20px var(--radar-green);
    line-height: 1;
  }

  h1 span { color: var(--radar-cyan); }

  .subtitle {
    font-size: 0.75rem;
    color: rgba(0,255,136,0.5);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .header-info {
    margin-left: auto;
    display: flex;
    gap: 24px;
    align-items: center;
  }

  .stat-badge {
    text-align: center;
    border: 1px solid rgba(0,255,136,0.2);
    padding: 4px 14px;
    border-radius: 4px;
    background: rgba(0,255,136,0.05);
  }

  .stat-badge .val {
    font-family: 'Orbitron', monospace;
    font-size: 1.3rem;
    color: var(--radar-cyan);
    text-shadow: 0 0 10px var(--radar-cyan);
    display: block;
  }

  .stat-badge .lbl {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    color: rgba(0,255,136,0.5);
    text-transform: uppercase;
  }

  .status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--radar-green);
    box-shadow: 0 0 12px var(--radar-green);
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* MAP */
  #map {
    position: fixed;
    top: 68px; left: 0; right: 340px; bottom: 0;
    z-index: 10;
  }

  /* Leaflet overrides */
  .leaflet-container {
    background: #020c14 !important;
  }

  /* SIDE PANEL */
  #panel {
    position: fixed;
    top: 68px; right: 0;
    width: 340px; bottom: 0;
    z-index: 100;
    background: var(--bg-panel);
    border-left: 1px solid rgba(0,255,136,0.2);
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(10px);
  }

  .panel-header {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(0,255,136,0.15);
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    color: var(--radar-cyan);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .panel-header .count {
    background: rgba(0,212,255,0.1);
    border: 1px solid rgba(0,212,255,0.3);
    padding: 2px 8px;
    border-radius: 2px;
    font-size: 0.8rem;
    color: var(--radar-cyan);
  }

  #flight-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  #flight-list::-webkit-scrollbar { width: 4px; }
  #flight-list::-webkit-scrollbar-track { background: transparent; }
  #flight-list::-webkit-scrollbar-thumb { background: rgba(0,255,136,0.2); border-radius: 2px; }

  .flight-card {
    border: 1px solid rgba(0,255,136,0.12);
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s;
    background: rgba(0,255,136,0.02);
    position: relative;
    overflow: hidden;
  }

  .flight-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: var(--radar-green);
    box-shadow: 0 0 8px var(--radar-green);
  }

  .flight-card:hover {
    border-color: rgba(0,255,136,0.4);
    background: rgba(0,255,136,0.06);
    transform: translateX(2px);
  }

  .flight-card.active {
    border-color: var(--radar-cyan);
    background: rgba(0,212,255,0.08);
  }

  .flight-card.active::before {
    background: var(--radar-cyan);
    box-shadow: 0 0 8px var(--radar-cyan);
  }

  .card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
  }

  .callsign {
    font-family: 'Orbitron', monospace;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--radar-green);
    text-shadow: 0 0 8px rgba(0,255,136,0.4);
  }

  .aircraft-type {
    font-size: 0.7rem;
    background: rgba(255,107,0,0.15);
    border: 1px solid rgba(255,107,0,0.3);
    color: var(--radar-orange);
    padding: 1px 6px;
    border-radius: 3px;
    letter-spacing: 0.1em;
    font-family: 'Orbitron', monospace;
  }

  .route {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: rgba(0,255,136,0.7);
    margin-bottom: 5px;
  }

  .route .city {
    font-weight: 600;
    color: #fff;
    font-size: 0.82rem;
  }

  .route .arrow {
    color: var(--radar-cyan);
    font-size: 0.9rem;
  }

  .flight-meta {
    display: flex;
    gap: 12px;
    font-size: 0.72rem;
    color: rgba(0,255,136,0.45);
    letter-spacing: 0.05em;
  }

  .flight-meta span { display: flex; align-items: center; gap: 3px; }

  /* Plane icon custom */
  .plane-marker {
    font-size: 20px;
    transform-origin: center;
    filter: drop-shadow(0 0 6px rgba(0,255,136,0.8));
    transition: filter 0.2s;
  }

  .plane-marker:hover {
    filter: drop-shadow(0 0 12px rgba(0,212,255,1));
  }

  /* Loading */
  #loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(2,12,20,0.9);
    z-index: 500;
    gap: 16px;
  }

  .loader-ring {
    width: 60px; height: 60px;
    border: 3px solid transparent;
    border-top-color: var(--radar-green);
    border-right-color: var(--radar-cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  #loading p {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: var(--radar-green);
    animation: blink 1.2s ease-in-out infinite;
  }

  /* Tooltip custom */
  .leaflet-popup-content-wrapper {
    background: rgba(2,15,25,0.97) !important;
    border: 1px solid rgba(0,255,136,0.4) !important;
    border-radius: 8px !important;
    box-shadow: 0 0 20px rgba(0,255,136,0.2) !important;
    color: var(--radar-green) !important;
    font-family: 'Rajdhani', sans-serif !important;
  }

  .leaflet-popup-tip {
    background: rgba(0,255,136,0.4) !important;
  }

  .popup-content { padding: 4px; min-width: 200px; }

  .popup-callsign {
    font-family: 'Orbitron', monospace;
    font-size: 1.1rem;
    color: var(--radar-cyan);
    font-weight: 700;
    margin-bottom: 8px;
    text-shadow: 0 0 10px var(--radar-cyan);
  }

  .popup-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.82rem;
    padding: 3px 0;
    border-bottom: 1px solid rgba(0,255,136,0.08);
  }

  .popup-row .key { color: rgba(0,255,136,0.5); }
  .popup-row .val { color: #fff; font-weight: 600; }

  /* Refresh btn */
  #refresh-btn {
    position: fixed;
    bottom: 20px; right: 356px;
    z-index: 200;
    background: rgba(0,20,35,0.9);
    border: 1px solid rgba(0,255,136,0.3);
    color: var(--radar-green);
    font-family: 'Orbitron', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(10px);
  }

  #refresh-btn:hover {
    background: rgba(0,255,136,0.1);
    border-color: var(--radar-green);
    box-shadow: 0 0 15px rgba(0,255,136,0.3);
  }

  .no-data {
    text-align: center;
    padding: 40px 20px;
    color: rgba(0,255,136,0.3);
    font-size: 0.8rem;
    letter-spacing: 0.1em;
  }

  .no-data .icon { font-size: 2rem; margin-bottom: 10px; display: block; }

  /* Coordinates display */
  #coords {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 200;
    font-family: 'Orbitron', monospace;
    font-size: 0.65rem;
    color: rgba(0,255,136,0.3);
    letter-spacing: 0.1em;
    pointer-events: none;
  }
</style>
</head>
<body>

<header>
  <div class="radar-icon"></div>
  <div>
    <h1>VENDÃ‰E <span>AIR</span> RADAR</h1>
    <div class="subtitle">Surveillance Trafic AÃ©rien Â· Zone 85</div>
  </div>
  <div class="header-info">
    <div class="stat-badge">
      <span class="val" id="count-stat">â€“</span>
      <span class="lbl">Vols dÃ©tectÃ©s</span>
    </div>
    <div class="stat-badge">
      <span class="val" id="time-stat">â€“</span>
      <span class="lbl">DerniÃ¨re MAJ</span>
    </div>
    <div style="display:flex;align-items:center;gap:6px;font-size:0.7rem;letter-spacing:0.1em;color:rgba(0,255,136,0.5)">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">INITIALISATION</span>
    </div>
  </div>
</header>

<div id="map"></div>

<div id="panel">
  <div class="panel-header">
    VOLS EN COURS
    <span class="count" id="panel-count">0</span>
  </div>
  <div id="flight-list">
    <div class="no-data">
      <span class="icon">ðŸ“¡</span>
      Chargement des donnÃ©es radar...
    </div>
  </div>
</div>

<button id="refresh-btn" onclick="fetchFlights()">âŸ³ ACTUALISER</button>
<div id="coords" id="coords">LAT: 46.67Â°N Â· LON: 1.43Â°W Â· ALT: VENDÃ‰E</div>

<!-- Loading overlay inside map area -->
<div id="loading" style="position:fixed;top:68px;left:0;right:340px;bottom:0;z-index:50">
  <div class="loader-ring"></div>
  <p>ACQUISITION DU SIGNAL...</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// â”€â”€â”€ CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VENDEE_CENTER = [46.67, -1.43];
const ZOOM = 9;

// Bounding box lÃ©gÃ¨rement Ã©largi autour de la VendÃ©e
const BBOX = {
  lamin: 46.2,
  lomin: -2.2,
  lamax: 47.1,
  lomax: -0.5
};

// OpenSky Network API (gratuit, no auth needed but limited)
const OPENSKY_URL = `https://opensky-network.org/api/states/all?lamin=${BBOX.lamin}&lomin=${BBOX.lomin}&lamax=${BBOX.lamax}&lomax=${BBOX.lomax}`;

// Fallback CORS proxy si nÃ©cessaire
const PROXY = 'https://corsproxy.io/?';

// â”€â”€â”€ AIRCRAFT TYPE DB (icao24 â†’ type, basÃ© sur prÃ©fixe) â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AIRLINE_CODES = {
  'AFR': 'Air France', 'EZY': 'easyJet', 'RYR': 'Ryanair',
  'BAW': 'British Airways', 'DLH': 'Lufthansa', 'IBE': 'Iberia',
  'VLG': 'Vueling', 'TAP': 'TAP Portugal', 'SWR': 'Swiss Air',
  'KLM': 'KLM', 'BEL': 'Brussels Airlines', 'WZZ': 'Wizz Air',
  'TUI': 'TUI', 'TVF': 'Transavia France', 'XL': 'XL Airways',
  'HOP': 'HOP!', 'AIB': 'Air Bretagne'
};

// â”€â”€â”€ INIT MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', {
  center: VENDEE_CENTER,
  zoom: ZOOM,
  zoomControl: true,
  attributionControl: false
});

// Tile sombre type aviation
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: 'Â© CartoDB',
  maxZoom: 18
}).addTo(map);

// Attributions discrÃ¨tes
L.control.attribution({ position: 'bottomleft', prefix: false }).addTo(map);

// â”€â”€â”€ DONNÃ‰ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let markers = [];
let flights = [];
let activeCard = null;
let refreshInterval;

// â”€â”€â”€ ICÃ”NE AVION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createPlaneIcon(heading, isSelected) {
  const color = isSelected ? '#00d4ff' : '#00ff88';
  const glow = isSelected ? '0 0 12px #00d4ff' : '0 0 8px rgba(0,255,136,0.8)';
  return L.divIcon({
    html: `<div style="
      transform: rotate(${heading || 0}deg);
      font-size: 22px;
      line-height: 1;
      filter: drop-shadow(${glow});
      color: ${color};
      text-align: center;
    ">âœˆ</div>`,
    className: '',
    iconSize: [28, 28],
    iconAnchor: [14, 14]
  });
}

// â”€â”€â”€ FETCH VOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchFlights() {
  document.getElementById('status-dot').style.background = '#ffaa00';
  document.getElementById('status-dot').style.boxShadow = '0 0 12px #ffaa00';
  document.getElementById('status-text').textContent = 'ACQUISITION...';

  let data = null;

  try {
    // Tentative directe OpenSky
    const response = await fetch(OPENSKY_URL, { signal: AbortSignal.timeout(8000) });
    if (response.ok) {
      data = await response.json();
    }
  } catch (e) {
    // Si CORS bloquÃ©, on essaie le proxy
    try {
      const response = await fetch(PROXY + encodeURIComponent(OPENSKY_URL), {
        signal: AbortSignal.timeout(10000)
      });
      if (response.ok) data = await response.json();
    } catch (e2) {
      console.warn('API inaccessible, utilisation donnÃ©es dÃ©mo');
    }
  }

  const states = data?.states || null;

  if (states && states.length > 0) {
    processFlights(states);
    document.getElementById('status-dot').style.background = 'var(--radar-green)';
    document.getElementById('status-dot').style.boxShadow = '0 0 12px var(--radar-green)';
    document.getElementById('status-text').textContent = 'EN DIRECT';
  } else {
    // DonnÃ©es dÃ©mo si API non disponible
    loadDemoData();
    document.getElementById('status-dot').style.background = '#ff6b00';
    document.getElementById('status-dot').style.boxShadow = '0 0 12px #ff6b00';
    document.getElementById('status-text').textContent = 'MODE DÃ‰MO';
  }

  const now = new Date();
  document.getElementById('time-stat').textContent =
    now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

  document.getElementById('loading').style.display = 'none';
}

// â”€â”€â”€ TRAITEMENT VOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function processFlights(states) {
  // Nettoyer anciens markers
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  flights = [];

  const filtered = states.filter(s =>
    s[5] !== null && s[6] !== null && // lon, lat
    s[5] >= BBOX.lomin && s[5] <= BBOX.lomax &&
    s[6] >= BBOX.lamin && s[6] <= BBOX.lamax
  );

  filtered.forEach((state, i) => {
    const flight = parseState(state, i);
    if (!flight) return;
    flights.push(flight);
    addMarker(flight);
  });

  document.getElementById('count-stat').textContent = flights.length;
  document.getElementById('panel-count').textContent = flights.length;
  renderList();
}

function parseState(s, idx) {
  const icao24 = s[0] || '';
  const callsign = (s[1] || '').trim() || 'N/A';
  const origin_country = s[2] || '?';
  const lon = s[5];
  const lat = s[6];
  const baro_alt = s[7] ? Math.round(s[7]) : null;
  const on_ground = s[8];
  const velocity = s[9] ? Math.round(s[9] * 3.6) : null; // m/s â†’ km/h
  const true_track = s[10] || 0;
  const vert_rate = s[11];
  const squawk = s[13] || '';

  if (!lat || !lon || on_ground) return null;

  // Deviner compagnie depuis callsign
  const prefix = callsign.replace(/[0-9]+$/, '').substring(0, 3);
  const airline = AIRLINE_CODES[prefix] || origin_country;

  // Type avion (estimation basique)
  const acType = guessAircraftType(callsign, icao24);

  return {
    id: icao24,
    callsign,
    airline,
    acType,
    lat, lon,
    altitude: baro_alt,
    speed: velocity,
    heading: true_track,
    squawk,
    from: guessOrigin(callsign),
    to: guessDest(callsign),
    idx
  };
}

// â”€â”€â”€ MARQUEURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMarker(flight) {
  const marker = L.marker([flight.lat, flight.lon], {
    icon: createPlaneIcon(flight.heading, false),
    zIndexOffset: 100
  }).addTo(map);

  marker.on('click', () => selectFlight(flight.id, marker));

  // Popup au survol
  marker.bindPopup(buildPopup(flight), {
    maxWidth: 240,
    autoPan: false
  });
  marker.on('mouseover', () => marker.openPopup());
  marker.on('mouseout', () => marker.closePopup());

  markers.push(marker);
  flight._marker = marker;
}

function buildPopup(f) {
  const alt = f.altitude ? `${f.altitude.toLocaleString()} m` : 'N/A';
  const spd = f.speed ? `${f.speed} km/h` : 'N/A';
  return `<div class="popup-content">
    <div class="popup-callsign">âœˆ ${f.callsign}</div>
    <div class="popup-row"><span class="key">Compagnie</span><span class="val">${f.airline}</span></div>
    <div class="popup-row"><span class="key">Type</span><span class="val">${f.acType}</span></div>
    <div class="popup-row"><span class="key">DÃ©part</span><span class="val">${f.from}</span></div>
    <div class="popup-row"><span class="key">ArrivÃ©e</span><span class="val">${f.to}</span></div>
    <div class="popup-row"><span class="key">Altitude</span><span class="val">${alt}</span></div>
    <div class="popup-row"><span class="key">Vitesse</span><span class="val">${spd}</span></div>
    <div class="popup-row"><span class="key">Cap</span><span class="val">${Math.round(f.heading)}Â°</span></div>
  </div>`;
}

// â”€â”€â”€ LISTE LATÃ‰RALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const list = document.getElementById('flight-list');
  if (flights.length === 0) {
    list.innerHTML = `<div class="no-data">
      <span class="icon">âœˆ</span>
      Aucun vol dÃ©tectÃ©<br>au-dessus de la VendÃ©e
    </div>`;
    return;
  }

  list.innerHTML = flights.map(f => `
    <div class="flight-card" id="card-${f.id}" onclick="selectFlight('${f.id}')">
      <div class="card-top">
        <span class="callsign">${f.callsign}</span>
        <span class="aircraft-type">${f.acType}</span>
      </div>
      <div class="route">
        <span class="city">${f.from}</span>
        <span class="arrow">â†’</span>
        <span class="city">${f.to}</span>
      </div>
      <div class="flight-meta">
        <span>â†• ${f.altitude ? f.altitude.toLocaleString() + 'm' : 'N/A'}</span>
        <span>âš¡ ${f.speed ? f.speed + ' km/h' : 'N/A'}</span>
        <span>ðŸ§­ ${Math.round(f.heading)}Â°</span>
      </div>
    </div>
  `).join('');
}

function selectFlight(id, marker) {
  // Reset ancien actif
  if (activeCard) {
    document.getElementById(`card-${activeCard}`)?.classList.remove('active');
    const old = flights.find(f => f.id === activeCard);
    if (old?._marker) old._marker.setIcon(createPlaneIcon(old.heading, false));
  }

  activeCard = id;
  const flight = flights.find(f => f.id === id);
  if (!flight) return;

  // Activer carte
  const card = document.getElementById(`card-${id}`);
  card?.classList.add('active');
  card?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  // Mettre Ã  jour marqueur
  if (flight._marker) {
    flight._marker.setIcon(createPlaneIcon(flight.heading, true));
    flight._marker.openPopup();
  }

  // Centrer carte
  map.setView([flight.lat, flight.lon], Math.max(map.getZoom(), 10), { animate: true });
}

// â”€â”€â”€ DONNÃ‰ES DÃ‰MO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadDemoData() {
  const demoFlights = [
    { id: 'a1b2c3', callsign: 'AFR1421', airline: 'Air France', acType: 'A320', lat: 46.82, lon: -1.78, altitude: 9500, speed: 830, heading: 195, from: 'Paris CDG', to: 'Biarritz', squawk: '1234' },
    { id: 'd4e5f6', callsign: 'TVF3201', airline: 'Transavia', acType: 'B737', lat: 46.65, lon: -1.22, altitude: 11000, speed: 870, heading: 285, from: 'Lyon', to: 'Nantes', squawk: '5678' },
    { id: 'g7h8i9', callsign: 'EZY4523', airline: 'easyJet', acType: 'A319', lat: 46.45, lon: -1.65, altitude: 8200, speed: 790, heading: 130, from: 'Bristol', to: 'Bordeaux', squawk: '9012' },
    { id: 'j1k2l3', callsign: 'RYR6711', airline: 'Ryanair', acType: 'B737', lat: 46.90, lon: -0.95, altitude: 12500, speed: 890, heading: 230, from: 'Dublin', to: 'Marseille', squawk: '3456' },
    { id: 'm4n5o6', callsign: 'HOP4821', airline: 'HOP!', acType: 'ATR72', lat: 46.55, lon: -1.45, altitude: 5500, speed: 520, heading: 68, from: 'La Rochelle', to: 'Rennes', squawk: '7890' },
    { id: 'p7q8r9', callsign: 'AFR8834', airline: 'Air France', acType: 'A321', lat: 47.02, lon: -1.55, altitude: 10700, speed: 855, heading: 170, from: 'Paris ORY', to: 'Brest', squawk: '2345' },
    { id: 's1t2u3', callsign: 'VLG6601', airline: 'Vueling', acType: 'A320', lat: 46.72, lon: -2.10, altitude: 9100, speed: 820, heading: 45, from: 'Barcelone', to: 'Nantes', squawk: '6789' },
    { id: 'v4w5x6', callsign: 'WZZ8903', airline: 'Wizz Air', acType: 'A321neo', lat: 46.38, lon: -0.78, altitude: 11200, speed: 875, heading: 310, from: 'Budapest', to: 'La Rochelle', squawk: '0123' },
  ];

  markers.forEach(m => map.removeLayer(m));
  markers = [];
  flights = [];

  demoFlights.forEach(f => {
    flights.push(f);
    addMarker(f);
  });

  document.getElementById('count-stat').textContent = flights.length;
  document.getElementById('panel-count').textContent = flights.length;
  renderList();
}

// â”€â”€â”€ UTILITAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function guessAircraftType(callsign, icao24) {
  const prefix = callsign.replace(/[0-9]+$/, '').substring(0, 3);
  const types = {
    'AFR': 'A320', 'TVF': 'B737', 'EZY': 'A319', 'RYR': 'B737',
    'VLG': 'A320', 'HOP': 'ATR72', 'KLM': 'B738', 'DLH': 'A321',
    'BAW': 'B777', 'TAP': 'A321neo', 'WZZ': 'A321neo', 'TUI': 'B737'
  };
  return types[prefix] || 'A320';
}

function guessOrigin(callsign) {
  const origins = ['Paris CDG', 'Lyon', 'Nantes', 'Bordeaux', 'Rennes', 'Brest',
    'La Rochelle', 'Toulouse', 'Marseille', 'Nice', 'Dublin', 'Londres',
    'Amsterdam', 'Barcelone', 'Madrid', 'Lisbonne', 'Rome'];
  return origins[Math.floor(callsign.charCodeAt(3) % origins.length)];
}

function guessDest(callsign) {
  const dests = ['Paris ORY', 'Nantes', 'Bordeaux', 'Biarritz', 'Toulouse',
    'Marseille', 'Nice', 'Lyon', 'Brest', 'Rennes', 'La Rochelle',
    'GenÃ¨ve', 'Bruxelles', 'Berlin', 'Rome', 'Barcelone', 'SÃ©ville'];
  return dests[Math.floor(callsign.charCodeAt(4) % dests.length)];
}

// â”€â”€â”€ LANCEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ajouter cercle de zone VendÃ©e
L.circle([46.67, -1.43], {
  radius: 70000,
  color: 'rgba(0,255,136,0.15)',
  fillColor: 'rgba(0,255,136,0.02)',
  fillOpacity: 1,
  weight: 1,
  dashArray: '8 4'
}).addTo(map);

// Label VendÃ©e sur la carte
L.marker([46.67, -1.43], {
  icon: L.divIcon({
    html: `<div style="
      font-family:'Orbitron',monospace;
      font-size:10px;
      color:rgba(0,255,136,0.25);
      letter-spacing:0.3em;
      white-space:nowrap;
      pointer-events:none;
    ">â”€â”€ VENDÃ‰E â”€â”€</div>`,
    className: '',
    iconAnchor: [36, 0]
  })
}).addTo(map);

// Lancer fetch au chargement
fetchFlights();

// Auto-refresh toutes les 30 secondes
refreshInterval = setInterval(fetchFlights, 30000);

// Countdown refresh
let countdown = 30;
setInterval(() => {
  countdown--;
  if (countdown <= 0) countdown = 30;
  const btn = document.getElementById('refresh-btn');
  if (btn) btn.textContent = `âŸ³ ACTUALISER (${countdown}s)`;
}, 1000);

</script>
</body>
</html>
